<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="projectMapper">
	
	<select id="selectList" resultType="ProjectVo">
		SELECT 
		    P.NO  
		    , M.NAME LEADER
		    , M.NAME NAME
		    , P.TITLE
		    , P.CONTENT
		    , P.START_DATE
		    , P.END_DATE
		FROM PROJECT P
		JOIN MEMBER M ON M.NO = P.WRITER
		WHERE M.NO = #{no}
		ORDER BY NO DESC
	</select>
    
    <insert id="insertOne">
    	INSERT INTO PROJECT
			(
			    NO
			    , LEADER
			    , WRITER
			    , TITLE
			    , CONTENT
			    , START_DATE
			    , END_DATE
			)
			VALUES
			(
			    SEQ_PROJECT_NO.NEXTVAL
			    , #{leader}
			    , #{writer}
			    , #{title}
			    , #{content}
			    , #{startDate}
			    , #{endDate}
			)   
    </insert>
    
    <select id="selectPrjNo" resultType="projectVo">
    	SELECT
    		NO
    	FROM PROJECT
    	WHERE = #{no}	
    </select>
    
    <insert id="insertPrjMember">
		INSERT INTO PROJECT_MEMBER 
		(  
		    NO
		    , PRJ_NO
		    , MEM_NO
		    , START_DATE
		)
		VALUES
		(
		    SEQ_PROJECT_MEMBER_NO.NEXTVAL
		    , #{no}
		    , #{memberNo}
		    , SYSDATE
		)
    </insert>
    
    
    <select id="selectOne" resultType="ProjectVo">
    	SELECT 
		    P.NO 
		    , M.NAME AS WRITER
		    , P.TITLE 
		    , P.CONTENT 
		    , PC.STATUS AS PROGRESS
		    , P.ENROLL_DATE 
		    , P.START_DATE
		    , P.END_DATE
		FROM PROJECT P 
		LEFT JOIN MEMBER M ON P.WRITER = M.NO 
		LEFT JOIN PROGRESS_CATE PC ON P.PROGRESS = PC.NO
		WHERE P.NO = #{no}
    </select>
    
    <select id="selectMembers" resultType="ProjectVo">
    		SELECT
			    PM.NO
			    ,PM.PRJ_NO
			    , M.NAME AS MEMBER
			FROM PROJECT_MEMBER PM
			LEFT JOIN MEMBER M ON M.NO = PM.MEM_NO
			LEFT JOIN PROJECT P ON P.NO = PM.PRJ_NO
    	<foreach collection="list" item="member" open="(" close=")" separator=",">
			WHERE PM.PRJ_NO = #{member.no}
    	</foreach>
    </select>
    
   	<select id="selectMemberList" resultType="MemberVo">
		SELECT 
		    M.NO
		    , M.ID
		    , M.PWD
		    , M.NAME
		    , M.EMAIL
		    , M.PHONE
		    , M.BIRTHDAY
		    , M.BANK_NO
		    , B.NAME AS BANK_NAME
		    , M.ACCOUNT
		    , M.ADDRESS
		    , D.NO AS DEPT_NO
		    , D.NAME AS DEPT_NAME
		    , T.NO AS TEAM_NO
		    , T.NAME AS TEAM_NAME
		    , M.POSITION_NO
		    , P.POSITION AS POSITION_NAME
		    , M.AUTHORIZE_NO
		    , A.RANK AS AUTHORIZE_NAME
		    , M.JOIN_DATE
		    , M.MODIFY_DATE
		    , M.RESIGNATION_YN
		    , M.ENTRUST_NO
		    , F.NO AS FILE_NO 
		    , F.CHANGE_NAME as FILE_NAME
		    , F.ORIGIN_NAME AS FILE_ORIGIN_NAME
		FROM MEMBER M
		JOIN BANK B ON B.NO = M.BANK_NO
		JOIN POSITION P ON P.NO = M.POSITION_NO
		JOIN AUTHORIZE A ON A.NO = M.AUTHORIZE_NO
		JOIN DEPARTMENT D ON D.NO = M.DEPT_NO
		LEFT JOIN DEPARTMENT T ON T.NO = M.TEAM_NO
		LEFT JOIN 
		(
		    SELECT 
		        "NO",
		        "ORIGIN_NAME",
		        "MEMBER_NO",
		        "CHANGE_NAME",
		        "FILE_PATH",
		        "ENROLL_DATE",
		        "THUMB_YN"
		    FROM PROFILE_A
		    WHERE "THUMB_YN" = 'Y'
		) F ON M.NO = F.MEMBER_NO
		WHERE M.RESIGNATION_YN = 'N'
		<if test="keyword != null and keyword !='' and category != null and category != ''">
			AND ${category} LIKE '%${keyword}%'
		</if >
		<if test="keyword != null and keyword !='' and category == null" >
			AND M.ID LIKE '%${keyword}%'
		    OR M.NAME LIKE '%${keyword}%' 
		    OR M.EMAIL LIKE '%${keyword}%'
		    OR M.BIRTHDAY LIKE '%${keyword}%'
		    OR D.NAME LIKE '%${keyword}%'
		    OR T.NAME LIKE '%${keyword}%'
		    OR P.POSITION LIKE '%${keyword}%'
		    OR A.RANK LIKE '%${keyword}%'
		    OR M.JOIN_DATE LIKE '%${keyword}%'
		</if> 
		<if test="loginTeamNo == null and loginDeptNo != null">
			AND M.NO != #{loginNo}
			AND D.NO = #{loginDeptNo}
			AND D.NO != 1 
		</if>
		<if test="loginTeamNo != null and loginDeptNo != null">
			AND M.NO != #{loginNo}
			AND T.NO = #{loginTeamNo}
		</if>
	</select>
    
    
    
</mapper>